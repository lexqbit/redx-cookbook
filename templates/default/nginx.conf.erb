lua_package_path "<%= node['redx']['lua_resty_redis']['dir'] %>/lib/?.lua;;";

upstream lucid-launcher {
<% node['lucid']['server']['ports'].each do |port|%>
  server lucid-server01:<%= port %>;
  server lucid-server02:<%= port %>;
  server lucid-server03:<%= port %>;
<% end %>
}

server {
    # API
    listen 8081;

    location / {
        access_by_lua_file '<%= node['redx']['dir'] %>/api.lua';
    }
}

server {
    # MAIN
    listen 80;
    listen 443;

    proxy_set_header X-Forwarded-Port $server_port;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Protocol $scheme;
    proxy_set_header X-Real-IP $remote_addr;

    proxy_read_timeout 300;
    proxy_connect_timeout 3;
    proxy_buffering off;

    # set default upstream in case reference not found in redis
    set $upstream 'lucid-launcher';

    location / {
        access_by_lua_file '<%= node['redx']['dir'] %>/main.lua';

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For "$proxy_add_x_forwarded_for";
        proxy_intercept_errors on;
        error_page 502 504 = @launcher;
        proxy_pass http://$upstream;
    }

    location @launcher {
        proxy_pass http://lucid-launcher;
    }
}
